---
title: "mink_analysis"
author: "Eleonora Milea"
date: '2022-06-02'
output: html_document
---

```{r warning=FALSE}
# Loading libriaries
library(tidyverse)
library(sp)
library(mapview)
library(rgdal)
library(raster)
library(ncdf4)
library(sf)
library(rgeos)
library(runjags)


# working directory
setwd("C:/Users/elemi.LAPTOP-VIAG61N1/OneDrive - University of Glasgow/dissertation_watervole")
```

------------------------------------------------------------------------

### **Subsetting mink data**

```{r}
# Importing mink data
mink_sp <- readOGR("layers_27700/mink.shp",
                   GDAL1_integer64_policy = T)
str(mink_sp@data)
head(mink_sp@data)
mink_sp@bbox
mink_sp@proj4string
length(mink_sp@data$Occurrence)


# Removing duplicates
mink_sp <- remove.duplicates(mink_sp)
length(mink_sp@data$Occurrence)


# Taking out NAs from year 
mink_sp <- subset(mink_sp, Year != "NA")
range(mink_sp@data$Year)
length(mink_sp@data$Occurrence)


# Considering only data from 1999
mink_sp <- subset(mink_sp, Year > "1999")
range(mink_sp@data$Year)
length(mink_sp@data$Occurrence)


# Keeping only landcover that we need
mink_sp@data <- mink_sp@data[, c("Occurrence", "Year")]
names(mink_sp@data)
length(mink_sp@data$Year)


# Recoding present/absent into 1/0
mink_sp@data$Occurrence[mink_sp@data$Occurrence == "absent"] <- 0
mink_sp@data$Occurrence[mink_sp@data$Occurrence == "present"] <- 1
mink_sp@data$Occurrence <- as.integer(mink_sp@data$Occurrence)
unique(mink_sp@data$Occurrence)
length(mink_sp@data$Occurrence[mink_sp@data$Occurrence == 0])
length(mink_sp@data$Occurrence[mink_sp@data$Occurrence == 1])


# Subsetting only presence data (since the absence record is only 1, we will exclude this)
mink_sp <- subset(mink_sp, Occurrence == "1")
length(mink_sp@data$Occurrence)


# Plotting data
mapview(mink, axes = T,
        xlab = "Longitude",
        ylab = "Latitude",
        zcol = "Occurrence")
```


### **Creating the pseudo-absence points**

Now we generate random points to create pseudo-absences records 

```{r}
# Importing boundary
boundary <- readOGR("layers_27700/boundary_nohebrids.shp",
                    GDAL1_integer64_policy = T)
plot(boundary)

# Creating random records in the boundary area
mink_absence <- spsample(boundary, length(mink_sp), type = "random")
mink_absence@proj4string
mapview(mink_absence)
length(mink_absence)


# Transforming df into sp object
mink_absence <- SpatialPointsDataFrame(coords = mink_absence@coords,
                                       data = data.frame(Occurrence =
                                       rep(0, length(mink_absence)),
                                       Year = mink_sp$Year),
                                       proj4string = mink_sp@proj4string)
head(mink_absence@data)

# Binding presence and absence sp objects
mink <- rbind(mink_sp, mink_absence)


# Creating id column 
mink$id <- seq(1, nrow(mink))


# Plotting
mapview(mink, zcol = "Occurrence")
```

Cleaning the environment

```{r}
# Cleaning environment
rm(mink_sp)
rm(mink_absence)
gc()
```


------------------------------------------------------------------------

### **Layers: Land cover** 

Let's first import the data

```{r}
# Importing land cover
land_00 <- raster("layers_27700/cover/landcover_2000.tif")
land_07 <- raster("layers_27700/cover/landcover_2007.tif")
land_15 <- raster("layers_27700/cover/landcover_2015.tif")
land_17 <- raster("layers_27700/cover/landcover_2017.tif")
land_18 <- raster("layers_27700/cover/landcover_2018.tif") 
land_19 <- raster("layers_27700/cover/landcover_2019.tif")
land_20 <- raster("layers_27700/cover/landcover_2020.tif")
```

Now we will create buffers of 50 m to calculate the proportion of each land 
cover type at each buffer point. Let's first subset the observation points by time period,  and then create for each period a buffer. Since we only have discontinuous 
land cover across years, we will assume that land cover has not changed between
intervals.


```{r}
# Creating buffer for each time period
minkbuffer_00100 <- gBuffer(subset(mink, Year >= 2000 & Year <= 2004), width = 100, byid = T)
head(minkbuffer_00100@data)

# 2005 - 2012
minkbuffer_07100 <- gBuffer(subset(mink, Year >= 2005 & Year <= 2012), width = 100, byid = T)

# 2013 - 2016
minkbuffer_15100 <- gBuffer(subset(mink, Year >= 2013 & Year <= 2016), width = 100, byid = T)

# 2017
minkbuffer_17100 <- gBuffer(subset(mink, Year == 2017), width = 100, byid = T)

# 2018
minkbuffer_18100 <- gBuffer(subset(mink, Year == 2018), width = 100, byid = T)

# 2019
minkbuffer_19100 <- gBuffer(subset(mink, Year == 2019), width = 100, byid = T)

# 2020 - 2022
minkbuffer_20100 <- gBuffer(subset(mink, Year >= 2020), width = 100, byid = T)


# Tabulate raster for each time period using the buffer df
# 2000 - 2004
landcover_00100 <- data.frame(matrix(NA, nrow = length(minkbuffer_00100),
                                    ncol = 26))
head(landcover_00100)
names(landcover_00100) <- c( "1","2","3","4","5","6", "7", "8", "9", "10",
                            "11", "12", "13", "14", "15", "16", "17", "18",
                            "19", "20", "21", "22", "23", "24", "25", "26")
head(landcover_00100)

# 2005 - 2012
landcover_07100 <- data.frame(matrix(NA, nrow = length(minkbuffer_07100),
                                    ncol = 24))
names(landcover_07100) <- c( "1","2","3","4","5","6", "7", "8", "9", "10",
                            "11", "12", "13", "14", "15", "16", "17", "18",
                            "19", "20", "21", "22", "23", "24")

# 2013 - 2016
landcover_15100 <- data.frame(matrix(NA, nrow = length(minkbuffer_15100),
                                    ncol = 22))
names(landcover_15100) <- c( "1","2","3","4","5","6", "7", "8", "9", "10",
                            "11", "12", "13", "14", "15", "16", "17", "18",
                            "19", "20", "21", "22")

# 2017
landcover_17100 <- data.frame(matrix(NA, nrow = length(minkbuffer_17100),
                                    ncol = 21))
names(landcover_17100) <- c( "1","2","3","4","5","6", "7", "8", "9", "10",
                            "11", "12", "13", "14", "15", "16", "17", "18",
                            "19", "20", "21")

# 2018
landcover_18100 <- data.frame(matrix(NA, nrow = length(minkbuffer_18100),
                                    ncol = 21))
names(landcover_18100) <- c( "1","2","3","4","5","6", "7", "8", "9", "10",
                            "11", "12", "13", "14", "15", "16", "17", "18",
                            "19", "20", "21")

# 2019
landcover_19100 <- data.frame(matrix(NA, nrow = length(minkbuffer_19100),
                                    ncol = 21))
names(landcover_19100) <- c( "1","2","3","4","5","6", "7", "8", "9", "10",
                            "11", "12", "13", "14", "15", "16", "17", "18",
                            "19", "20", "21")

# 2020 - 2022
landcover_20100 <- data.frame(matrix(NA, nrow = length(minkbuffer_20100),
                                    ncol = 21))
names(landcover_20100) <- c( "1","2","3","4","5","6", "7", "8", "9", "10",
                            "11", "12", "13", "14", "15", "16", "17", "18",
                            "19", "20", "21")


# Intersecting each buffer with land cover
# 2000 - 2004
int.list00 <- list()
for (i in 1:length(minkbuffer_00100)){
  int.list00[[i]] <- raster::intersect(land_00, minkbuffer_00100[i,])
}

# 2005 - 2012
int.list07 <- list()
for (i in 1:length(minkbuffer_07100)){
  int.list07[[i]] <- raster::intersect(land_07,  minkbuffer_07100[i,])
}

# 2013 - 2016
int.list15 <- list()
for (i in 1:length(minkbuffer_15100)){
  int.list15[[i]] <- raster::intersect(land_15, minkbuffer_15100[i,])
}

# 2017
int.list17 <- list()
for (i in 1:length(minkbuffer_17100)){
  int.list17[[i]] <- raster::intersect(land_17, minkbuffer_17100[i,])
}

# 2018
int.list18 <- list()
for (i in 1:length(minkbuffer_18100)){
  int.list18[[i]] <- raster::intersect(land_18, minkbuffer_18100[i,])
}

# 2019
int.list19 <- list()
for ( i in 1:length(minkbuffer_19100)){
  int.list19[[i]] <- raster::intersect(land_19, minkbuffer_19100[i,])
}

# 2020 - 2022
int.list20 <- list()
for (i in 1:length(minkbuffer_20100)){
  int.list20[[i]] <- raster::intersect(land_20, minkbuffer_20100[i,])
}


# Counting pixel for each land cover type at buffer
# 2000 - 2004
for (i in 1:length(minkbuffer_00100)){
  for (j in 1:length(names(landcover_00100))) {
    landcover_00100[i,j] <- table(values(int.list00[[i]]))[as.character(names(landcover_00100)[j])]
  }}
head(landcover_00100)

# 2005 - 2012
for (i in 1:length(minkbuffer_07100)){
  for ( j in 1:length(names(landcover_07100))) {
    landcover_07100[i,j] <- table(
      values(int.list07[[i]]))[as.character(names(landcover_07100)[j])]
  }}

# 2013 - 2016
for (i in 1:length(minkbuffer_15100)){
  for ( j in 1:length(names(landcover_15100))) {
    landcover_15100[i,j] <- table(
      values(int.list15[[i]]))[as.character(names(landcover_15100)[j])]
  }}

# 2017
for (i in 1:length(minkbuffer_17100)){
  for ( j in 1:length(names(landcover_17100))) {
    landcover_17100[i,j] <- table(
      values(int.list17[[i]]))[as.character(names(landcover_17100)[j])]
  }}

# 2018
for (i in 1:length(minkbuffer_18100)){
   for ( j in 1:length(names(landcover_18100))) {
    landcover_18100[i,j] <- table(
      values(int.list18[[i]]))[as.character(names(landcover_18100)[j])]
  }}

# 2019
for (i in 1:length(minkbuffer_19100)){
  for ( j in 1:length(names(landcover_19100))) {
    landcover_19100[i,j] <- table(
      values(int.list19[[i]]))[as.character(names(landcover_19100)[j])]
  }}

# 2020
for (i in 1:length(minkbuffer_20100)){
  for ( j in 1:length(names(landcover_20100))) {
    landcover_20100[i,j] <- table(
      values(int.list20[[i]]))[as.character(names(landcover_20100)[j])]
  }}


# Changing categories name
names(landcover_00100) <- c ("broadleaved_woodland",
                            "coniferous_woodland",
                            "boundaries_linearfeatures",
                            "arable_horticulture",
                            "improved_grassland",
                            "neutral_grassland",
                            "calcareous_grassland",
                            "acid_grassland",
                            "bracken",
                            "dwarf_shrubheath",
                            "fen_marsh_swamp",
                            "bog",
                            "standingwater_canals",
                            "rivers",
                            "montane_habitats",
                            "inland_rock",
                            "builtup_areas",
                            "supralittoral_rock",
                            "supralittoral_sediment",
                            "littoral_rock",
                            "littoral_sediment",
                            "inshore_sublittoralsediment",
                            "inshore_sublittoralrock",
                            "offshore_shelfsediment",
                            "offshore_shelfrock",
                            "continential_shelfslope")

names(landcover_07100) <- c ("unclassified",
                            "broadleaved_woodland",
                            "coniferous_woodland",
                            "arable_horticulture",
                            "improved_grassland",
                            "rough_grassland",
                            "neutral_grassland",
                            "calcareous_grassland",
                            "acid_grassland",
                            "fen_marsh_swamp",
                            "heather",
                            "heather_grassland",
                            "bog",
                            "montane_habitats",
                            "inland_rock",
                            "saltwater",
                            "freshwater",
                            "supralittoral_rock",
                            "supralittoral_sediment",
                            "littoral_rock",
                            "littoral_sediment",
                            "saltmarsh",
                            "urban",
                            "suburban")


names(landcover_15100) <- c ("unclassified",
                            "broadleaved_woodland",
                            "coniferous_woodland",
                            "arable_horticulture",
                            "improved_grassland",
                            "neutral_grassland",
                            "calcareous_grassland",
                            "acid_grassland",
                            "fen_marsh_swamp",
                            "heather",
                            "heather_grassland",
                            "bog",
                            "inland_rock",
                            "saltwater",
                            "freshwater",
                            "supralittoral_rock",
                            "supralittoral_sediment",
                            "littoral_rock",
                            "littoral_sediment",
                            "saltmarsh",
                            "urban",
                            "suburban")

names(landcover_17100) <- c ("broadleaved_woodland",
                            "coniferous_woodland",
                            "arable_horticulture",
                            "improved_grassland",
                            "neutral_grassland",
                            "calcareous_grassland",
                            "acid_grassland",
                            "fen_marsh_swamp",
                            "heather",
                            "heather_grassland",
                            "bog",
                            "inland_rock",
                            "saltwater",
                            "freshwater",
                            "supralittoral_rock",
                            "supralittoral_sediment",
                            "littoral_rock",
                            "littoral_sediment",
                            "saltmarsh",
                            "urban",
                            "suburban")

names(landcover_18100) <- c ("broadleaved_woodland",
                            "coniferous_woodland",
                            "arable_horticulture",
                            "improved_grassland",
                            "neutral_grassland",
                            "calcareous_grassland",
                            "acid_grassland",
                            "fen_marsh_swamp",
                            "heather",
                            "heather_grassland",
                            "bog",
                            "inland_rock",
                            "saltwater",
                            "freshwater",
                            "supralittoral_rock",
                            "supralittoral_sediment",
                            "littoral_rock",
                            "littoral_sediment",
                            "saltmarsh",
                            "urban",
                            "suburban")

names(landcover_19100) <- c ("broadleaved_woodland",
                            "coniferous_woodland",
                            "arable_horticulture",
                            "improved_grassland",
                            "neutral_grassland",
                            "calcareous_grassland",
                            "acid_grassland",
                            "fen_marsh_swamp",
                            "heather",
                            "heather_grassland",
                            "bog",
                            "inland_rock",
                            "saltwater",
                            "freshwater",
                            "supralittoral_rock",
                            "supralittoral_sediment",
                            "littoral_rock",
                            "littoral_sediment",
                            "saltmarsh",
                            "urban",
                            "suburban")

names(landcover_20100) <- c ("broadleaved_woodland",
                            "coniferous_woodland",
                            "arable_horticulture",
                            "improved_grassland",
                            "neutral_grassland",
                            "calcareous_grassland",
                            "acid_grassland",
                            "fen_marsh_swamp",
                            "heather",
                            "heather_grassland",
                            "bog",
                            "inland_rock",
                            "saltwater",
                            "freshwater",
                            "supralittoral_rock",
                            "supralittoral_sediment",
                            "littoral_rock",
                            "littoral_sediment",
                            "saltmarsh",
                            "urban",
                            "suburban")
```


#### **Calculating proportion of each land cover type**

Now we need to calculate the proportion of each land cover type in all buffers.
First, we start with the data from 2000 to 2004.

```{r}
# Replacing NAs with 0
landcover_00100[is.na(landcover_00100)] <- 0
head(landcover_00100)
landcover_07100[is.na(landcover_07100)] <- 0
landcover_15100[is.na(landcover_15100)] <- 0
landcover_17100[is.na(landcover_17100)] <- 0
landcover_18100[is.na(landcover_18100)] <- 0
landcover_19100[is.na(landcover_19100)] <- 0
landcover_20100[is.na(landcover_20100)] <- 0


# Creating a list with all landcovers (I can probably remove this because I have it before when calculating the distance?)
landcover <- list(landcover_00100, landcover_07100, landcover_15100,
                  landcover_17100, landcover_18100, landcover_19100, landcover_20100)


# Keeping only variables with values >0 as these are the only one we need to calculate proportions for 
for(i in 1:length(landcover)){
landcover[[i]] <- landcover[[i]][sapply(landcover[[i]], function(x) any(x > 0))]
}
names(landcover) <- c("00", "07", "15", "17", "18", "19", "20")
summary(landcover)


# Calculating sum of all pixels for each id 
row_sum <- lapply(landcover, rowSums)
props <- list() # could probably change it back to "landcover"


# Calculating proportions
  # Iterating through each element of the list
  for(i in 1:length(landcover)){
    
    # Calculating proportion
    props[[i]] <- landcover[[i]]/row_sum[[i]]
    props[[i]] <- round(props[[i]], 3) # rounding up
  }
summary(props)


# Replacing NaNs with NAs
props <- rapply(props, f = function(x) ifelse(is.nan(x), 0, x),
                    how ="replace" ) 
head(props[[1]])


# Creating data frame for each period 
propcover_00 <- data.frame(props[[1]])
head(propcover_00)
propcover_07 <- data.frame(props[[2]])
head(propcover_07)
propcover_15 <- data.frame(props[[3]])
propcover_17 <- data.frame(props[[4]])
propcover_18 <- data.frame(props[[5]])
propcover_19 <- data.frame(props[[6]])
propcover_20 <- data.frame(props[[7]])


# Taking id for each time period 
id_00 <- minkbuffer_00100$id
id_07 <- minkbuffer_07100$id
id_15 <- minkbuffer_15100$id
id_17 <- minkbuffer_17100$id
id_18 <- minkbuffer_18100$id
id_19 <- minkbuffer_19100$id
id_20 <- minkbuffer_20100$id



# Adding variables to mink df
mink@data$unclassified <- 0
mink@data$woodland <- 0
mink@data$wetland <- 0
mink@data$urban <- 0
mink@data$freshwater <- 0
mink@data$grassland <- 0
mink@data$arable_horticulture <- 0
mink@data$montane_habitats <- 0
mink@data$inland_rock <- 0
mink@data$heather <- 0
mink@data$coastal_habitats <- 0
mink@data$sea <- 0


# 00
mink@data$wetland[id_00] <- propcover_00[,1] # fen,marsh,swamp
mink@data$coastal_habitats[id_00] <- propcover_00[,2]


# 07
names(propcover_07)
mink@data$unclassified[id_07] <- propcover_07[,1]
mink@data$woodland[id_07] <- rowSums(propcover_07[, c(2,3), drop = F]) # broadleaf,conifer
mink@data$arable_horticulture[id_07] <- propcover_07[,4]
mink@data$grassland[id_07] <- rowSums(propcover_07[, c(5:9), drop = F]) # improved, rough, neutral, calcareous, acid (should I include heather grassland?)
mink@data$wetland[id_07] <- rowSums(propcover_07[, c(10, 13), drop = F]) # fen,marsh,swamp,bog (should I also include saltmarsh?)
mink@data$heather[id_07] <- rowSums(propcover_07[, c(11, 12), drop = F]) # heather and heather grassland
mink@data$montane_habitats[id_07] <- propcover_07[,14]
mink@data$inland_rock[id_07] <- propcover_07[,15]
mink@data$sea[id_07] <- propcover_07[,16]
mink@data$coastal_habitats [id_07] <- rowSums(propcover_07[, c(17:21), drop = F]) #supralittoral/littoral rock/sediment, saltmarsh
mink@data$urban[id_07] <- propcover_07[,22]


# 15
names(propcover_15)
mink@data$unclassified[id_15] <- propcover_15[,1]
mink@data$woodland[id_15] <- rowSums(propcover_15[, c(2,3), drop = F]) # broadleaf,conifer
mink@data$arable_horticulture[id_15] <- propcover_15[,4]
mink@data$grassland[id_15] <- rowSums(propcover_15[, c(5:7), drop = F]) # improved, calcareous, acid (should I include heather grassland?)
mink@data$wetland[id_15] <- rowSums(propcover_15[, c(8, 11), drop = F]) # fen,marsh,swamp,bog (should I also include saltmarsh?)
mink@data$heather[id_15] <- rowSums(propcover_15[, c(9, 10), drop = F]) # heather and heather grassland
mink@data$inland_rock[id_15] <- propcover_15[,12]
mink@data$sea[id_15] <- propcover_15[,13]
mink@data$freshwater[id_15] <- propcover_15[,14]
mink@data$coastal_habitats [id_15] <- rowSums(propcover_15[, c(15:19), drop = F]) #supralittoral/littoral rock/sediment, saltmarsh
mink@data$urban[id_15] <- propcover_15[,20]



# 17
names(propcover_17)
mink@data$woodland[id_17] <- rowSums(propcover_17[, c(1,2), drop = F]) # broadleaf,conifer
mink@data$arable_horticulture[id_17] <- propcover_17[,3]
mink@data$grassland[id_17] <- rowSums(propcover_17[, c(4:5), drop = F]) # improved, acid (should I include heather grassland?)
mink@data$heather[id_17] <- rowSums(propcover_17[, c(6, 7), drop = F]) # heather and heather grassland
mink@data$wetland[id_17] <- rowSums(propcover_17[, c(8), drop = F]) # bog
mink@data$inland_rock[id_17] <- propcover_17[,9]
mink@data$sea[id_17] <- propcover_17[,10]
mink@data$freshwater[id_17] <- propcover_17[,11]
mink@data$coastal_habitats [id_17] <- rowSums(propcover_17[, c(12:16), drop = F]) #supralittoral/littoral rock/sediment, saltmarsh
mink@data$urban[id_17] <- rowSums(propcover_17[, c(17,18), drop = F]) # suburban, urban


# 18
names(propcover_18)
mink@data$woodland[id_18] <- rowSums(propcover_18[, c(1,2), drop = F]) # broadleaf,conifer
mink@data$arable_horticulture[id_18] <- propcover_18[,3]
mink@data$grassland[id_18] <- rowSums(propcover_18[, c(4:5), drop = F]) # improved, acid (should I include heather grassland?)
mink@data$heather[id_18] <- rowSums(propcover_18[, c(6, 7), drop = F]) # heather and heather grassland
mink@data$wetland[id_18] <- rowSums(propcover_18[, c(8), drop = F]) # bog
mink@data$sea[id_18] <- propcover_18[,9]
mink@data$freshwater[id_18] <- propcover_18[,10]
mink@data$coastal_habitats [id_18] <- rowSums(propcover_18[, c(11:15), drop = F]) #supralittoral/littoral rock/sediment, saltmarsh
mink@data$urban[id_18] <- rowSums(propcover_18[, c(16,17), drop = F]) # suburban, urban


# 19
names(propcover_19)
mink@data$woodland[id_19] <- rowSums(propcover_19[, c(1,2), drop = F]) # broadleaf,conifer
mink@data$arable_horticulture[id_19] <- propcover_19[,3]
mink@data$grassland[id_19] <- rowSums(propcover_19[, c(4:5), drop = F]) # improved, acid (should I include heather grassland?)
mink@data$heather[id_19] <- rowSums(propcover_19[, c(6, 7), drop = F]) # heather and heather grassland
mink@data$wetland[id_19] <- rowSums(propcover_19[, c(8), drop = F]) # bog
mink@data$inland_rock[id_19] <- propcover_19[,9]
mink@data$sea[id_19] <- propcover_19[,10]
mink@data$freshwater[id_19] <- propcover_19[,11]
mink@data$coastal_habitats [id_19] <- rowSums(propcover_19[, c(12:16), drop = F]) #supralittoral/littoral rock/sediment, saltmarsh
mink@data$urban[id_19] <- rowSums(propcover_19[, c(17,18), drop = F]) # suburban, urban


# 20
names(propcover_20)
mink@data$woodland[id_20] <- rowSums(propcover_20[, c(1,2), drop = F]) # broadleaf,conifer
mink@data$arable_horticulture[id_20] <- propcover_20[,3]
mink@data$grassland[id_20] <- rowSums(propcover_20[, c(4:5), drop = F]) # improved, acid (should I include heather grassland?)
mink@data$heather[id_20] <- rowSums(propcover_20[, c(6, 7), drop = F]) # heather and heather grassland
mink@data$wetland[id_20] <- rowSums(propcover_20[, c(8), drop = F]) # bog
mink@data$inland_rock[id_20] <- propcover_20[,9]
mink@data$sea[id_20] <- propcover_20[,10]
mink@data$freshwater[id_20] <- propcover_20[,11]
mink@data$coastal_habitats [id_20] <- rowSums(propcover_20[, c(12:16), drop = F]) #supralittoral/littoral rock/sediment, saltmarsh
mink@data$urban[id_20] <- rowSums(propcover_20[, c(17,18), drop = F]) # suburban, urban

head(mink)
```


Cleaning the environment

```{r}
rm(propcover_00)
rm(propcover_07)
rm(propcover_15)
rm(propcover_17)
rm(propcover_18)
rm(propcover_19)
rm(propcover_20)
rm(props)
rm(row_sum)
gc()
```

#### **Calculating distance from land cover**

```{r}
conifer_r_00all <- readAll(land_00)

# conifer_r_00 <- raster(ext = conifer_r_00@extent, ncols = 26, nrow = 180,
#                        crs = conifer_r_00@crs,
#                        vals = conifer_r_00@data@values,
#                        resolution = 25.00001)
conifer_r_00 <- raster(ncol = 26, ext = conifer_r_00all@extent,
                       crs = conifer_r_00all@crs)
conifer_r_00 <- raster(land_00)
summary(values(conifer_r_00))
names(conifer_r_00) <- c ("broadleaved_woodland",
                            "coniferous_woodland",
                            "boundaries_linearfeatures",
                            "arable_horticulture",
                            "improved_grassland",
                            "neutral_grassland",
                            "calcareous_grassland",
                            "acid_grassland",
                            "bracken",
                            "dwarf_shrubheath",
                            "fen_marsh_swamp",
                            "bog",
                            "standingwater_canals",
                            "rivers",
                            "montane_habitats",
                            "inland_rock",
                            "builtup_areas",
                            "supralittoral_rock",
                            "supralittoral_sediment",
                            "littoral_rock",
                            "littoral_sediment",
                            "inshore_sublittoralsediment",
                            "inshore_sublittoralrock",
                            "offshore_shelfsediment",
                            "offshore_shelfrock",
                            "continential_shelfslope")
values(conifer_r_00)[values(conifer_r_00)!= "2"] <- NA # 2 is the code of conifers
values(conifer_r_00)[!is.na(values(conifer_r_00))] <- 0
# plot(conifer_r_00)
# plot(land_00)

d_conifer_00 <- distance(conifer_r_00) # raster of distances between pixels that don't have conifers and conifers
# plot(d.conifer)

mink@data$d_conifer_00 <- raster::extract(d_conifer_00, mink)
```


------------------------------------------------------------------------


### **Layers: National parks/reservoirs**

Let's first start by calculating distance of points from reserves

```{r}
# Importing reserves boundaries
reserves <- readOGR("layers_27700/reserves.shp",
                    GDAL1_integer64_policy = T)
mapview(reserves)
head(reserves@data)


# distance calculation between points and nearest reserve
dist_reserves <- gDistance(reserves, mink, byid = T)
mink@data$dist_reserves <- apply(dist_reserves, MARGIN = 1, FUN = min) 
head(mink@data)
mink@data$dist_reserves <- round(mink@data$dist_reserves, 0)
head(mink@data$dist_reserves)
```


Now, we do the same with national parks

```{r}
# Importing national parks
nat_parks <- readOGR("layers_27700/national_parks.shp",
                     GDAL1_integer64_policy = T)
mapview(nat_parks)
head(nat_parks@data)


# distance calculation between points and nearest park
dist_parks <- gDistance(nat_parks, mink, byid = T)
mink@data$dist_parks <- apply(dist_parks, MARGIN = 1, FUN = min) 
head(mink@data)
mink@data$dist_parks <- round(mink@data$dist_parks, 0)
head(mink@data$dist_parks)
```


Now, we calculate distance from ramsars

```{r}
# Importing ramsars
ramsars <- readOGR("layers_27700/ramsar.shp",
                  GDAL1_integer64_policy = T)
mapview(ramsars) +
  mapview(mink, zcol = "Occurrence")
head(ramsars@data)

# distance calculation between points and nearest ramsar
dist_ramsars <- gDistance(ramsars, mink, byid = T)
mink@data$dist_ramsars <- apply(dist_ramsars, MARGIN = 1, FUN = min) 
head(mink@data)
mink@data$dist_ramsars <- round(mink@data$dist_ramsars, 0)
head(mink@data$dist_ramsars)
```


Finally, we clean again the environment, from objects that we do not need anymore

```{r}
rm(ramsars)
rm(reserves)
rm(nat_parks)
rm(dist_reserves)
rm(dist_parks)
rm(dist_ramsars)
gc()
```


------------------------------------------------------------------------

### **Layers: Rainfall**

Now we calculate the rainfall levels at each observation point. We will need to
repeat this for every year. However, we only have rainfall records up to 2020, 
hence for the last two years we will use the rainfall occurred in 2020.

```{r}
# Importing rainfall
rainf_files <- list.files(path = "C:/Users/elemi.LAPTOP-VIAG61N1/OneDrive - University of Glasgow/dissertation_watervole/layers_27700/rainfall",
                          all.files = T, pattern = "nc$") 
setwd("C:/Users/elemi.LAPTOP-VIAG61N1/OneDrive - University of Glasgow/dissertation_watervole/layers_27700/rainfall") # need this line to run next one

# Import raster
rainfall <- lapply(rainf_files, raster) 

# Subsetting observations per year
mink_byyear<- split(mink, mink$Year)
mink_byyear[["2020"]] <- c(mink_byyear[["2020"]]
                         + mink_byyear[["2021"]]
                         + mink_byyear[["2022"]]) # combining 2020-2021-2022 records
mink_byyear["2020"] <- unlist(mink_byyear[["2020"]])
mink_byyear[["2021"]] <- NULL
mink_byyear[["2022"]] <- NULL


# Extracting rainfall at observation point
mink_rainf <- list() # empty list to store records

for(i in 1:length(rainfall)){
    mink_rainf[[i]] <- raster::extract(rainfall[[i]], mink_byyear[[i]])
}
str(mink_rainf)
names(mink_rainf) <- seq(2000, 2020)


# Transferring obs to mink df
mink$rainfall <- NA # empty column to store rainf records

for(i in 1:length(mink_byyear)){
  id <- mink_byyear[[i]]["id"] # take id from each year
  id <- unlist(id@data[[1]]) # unlist it to make it a vector

mink$rainfall[id] <- mink_rainf[[i]] # put rainf records at id positions in mink df
}
head(mink$rainfall)
```


Cleaning environment


```{r}
rm(mink_rainf)
rm(rainf_files)
rm(rainfall)
gc()
```

------------------------------------------------------------------------

### **Layers: Temperature**

Now we calculate the temperature levels at each observation point. We will need to
repeat this for every year. However, we only have temperature records up to 2020, 
hence for the last two years we will use the temperature recorded in 2020.

```{r}
# Importing temperature
temp_files <- list.files(path = "C:/Users/elemi.LAPTOP-VIAG61N1/OneDrive - University of Glasgow/dissertation_watervole/layers_27700/temperature",
                          all.files = T, pattern = "nc$") 
setwd("C:/Users/elemi.LAPTOP-VIAG61N1/OneDrive - University of Glasgow/dissertation_watervole/layers_27700/temperature") # need this line to run next one
temperature <- lapply(temp_files, raster) 

# Extracting temperature at observation point
mink_temp <- list() # empty list to store values

for(i in 1:length(temperature)){
    mink_temp[[i]] <- raster::extract(temperature[[i]], mink_byyear[[i]])
}
str(mink_temp)
names(mink_temp) <- seq(2000, 2020)


# Transferring obs to mink df
mink$temperature <- NA # empty column to store temp records

for(i in 1:length(mink_byyear)){
  id <- mink_byyear[[i]]["id"] # take id from each year
  id <- unlist(id@data[[1]]) # unlist it to make it a vector

mink$temperature[id] <- mink_temp[[i]] # put temp records at id positions in mink df
}
head(mink$temperature)
```

Cleaning environment

```{r}
rm(temp_files)
rm(temperature)
rm(mink_temp)
rm(mink_byyear)
gc()
```

------------------------------------------------------------------------

### **Layers: Elevation, slope, aspect**


```{r}
# Importing elevation
elev <- raster("C:/Users/elemi.LAPTOP-VIAG61N1/OneDrive - University of Glasgow/dissertation_watervole/layers_27700/dem_50m.tif")
elev@ncols
elev@nrows
elev@extent
mapview(elev)

# Extracting elevation at obs points
elev_mink <- raster::extract(elev, mink)
mink@data$elevation <- elev_mink
head(mink$elevation)
```


Now we calculate slope and aspect using the elevation raster

```{r}
# Calculating slope 
slope <- terrain(elev, opt = "slope",
                 neighbors = 8, units = "degrees")
mapview(slope)

# Extracting slope at obs points
slope_mink <- raster::extract(slope, mink)
mink@data$slope <- slope_mink
head(mink$slope)

# Calculating aspect
aspect <- terrain(elev, opt = "aspect",
                  neighbors = 8, units = "degrees")
mapview(aspect)

# Extracting aspect at obs points
aspect_mink <- raster::extract(aspect, mink)
mink@data$aspect <- aspect_mink
head(mink$aspect)
```

Cleaning the environment

```{r}
rm(elev)
rm(elev_mink)
rm(aspect)
rm(aspect_mink)
rm(slope)
rm(slope_mink)
gc()
```

------------------------------------------------------------------------

### **Layers: Roads**

Now we will do the same with the road shapefile.

```{r}
roads <- readOGR("C:/Users/elemi.LAPTOP-VIAG61N1/OneDrive - University of Glasgow/dissertation_watervole/layers_27700/roads.shp",
                 GDAL1_integer64_policy = T)
mapview(roads)
head(roads@data)
unique(roads@data$fclass)


# Subsetting
roads <- subset(roads, fclass == "residential" | fclass == "motorway"
                | fclass == "secondary" | fclass == "path"
                | fclass == "footway")
unique(roads@data$fclass)


# Distance calculation between points and nearest road
dist_roads <- gDistance(roads, mink, byid = T)
mink@data$dist_roads <- apply(dist_roads, MARGIN = 1, FUN = min) 
head(mink@data)
```


Cleaning environment

```{r}
rm(roads)
rm(dist_roads)
gc()
```

------------------------------------------------------------------------
### **Layers: Waterways**

After importing the waterways shapefile, we will need to calculate the distance
from each observation point to the nearest waterway.

```{r}
# Importing waterways
water <- readOGR("C:/Users/elemi.LAPTOP-VIAG61N1/OneDrive - University of Glasgow/dissertation_watervole/layers_27700/waterways.shp",
                 GDAL1_integer64_policy = T)
mapview(water)
head(water@data)
unique(water@data$layer)


# distance calculation between points and nearest waterway
dist_water <- gDistance(water, mink, byid = T)
mink@data$dist_water <- apply(dist_water, MARGIN = 1, FUN = min) # take the matrix and for each row take the minimum distance (2 would have been for each column)
head(mink@data)
```


Cleaning environment

```{r}
rm(water)
rm(dist_water)
gc()
```




------------------------------------------------------------------------

### **JAGS models**

```{r}
# JAGS model0 - most complex model
model0 <- 'model{

# Main loop
for(i in 1:length(mink$Occurrence)){
minkoccurrence[i] ~ dbern(prob[i])
logit(prob[i]) <- intercept +
distancewater * dist_water[i] +
distanceroads * dist_roads[i] +
distancereserves * dist_reserves[i] +
distanceramsars * dist_ramsars[i] +
distanceparks * dist_parks[[i] +
rainfeffect * rainfall[i] +
rainfquadratic * rainfall[i]^2 +
tempeffect * temperature[i] + 
tempquadratic * temperature[i]^2 +
eleveffect * elevation[i] +
elevquadratic * elevation[i]^2 +
elevtemp_interaction * temperature[i] * elevation[i] + 
elevrainf_interaction * rainfall[i] * elevation[i] + 
slopeeffect * slope[i] + 
slopequadratic * slope[i]^2 +
aspecteffect * aspect[i] + # quadratic effect?
propbuff_unclass * unclassified[i] +
propbuff_woodland * woodland[i] +
propbuff_wetland * wetland[i] +
propbuff_urban * urban[i] +
propbuff_freshwater * freshwater[i] +
propbuff_grassland * grassland[i] +
propbuff_arable * arable_horticulture[i] +
propbuff_montane * montane_habitats[i] +
propbuff_inlandrock * inland_rock[i] +
propbuff_heather * heather[i] +
propbuff_coastal * coastal_habitats[i] +
propbuff_sea * sea[i]
dist_unclass * dist_unclassified[i] +
dist_woodland * dist_woodland[i] +
dist_wetland * dist_wetland[i] +
dist_urban * dist_urban[i] +
dist_freshwater * dist_freshwater[i] +
dist_grassland * dist_grassland[i] +
dist_arable * dist_arable_horticulture[i] +
dist_montane * dist_montane_habitats[i] +
dist_inlandrock * dist_inland_rock[i] +
dist_heather * dist_heather[i] +
dist_coastal * dist_coastal_habitats[i] +
dist_sea * dist_sea[i]
}


# Priors 
intercept ~ dnorm(0, 10^-6) # normal distribution?
distancewater ~ dgamma(0.001, 0.001)
distanceroads ~ dgamma(0.001, 0.001)
distancereserves ~ dgamma(0.001, 0.001)
distanceramsars ~ dgamma(0.001, 0.001)
distanceparks ~ dgamma(0.001, 0.001)
rainfeffect ~ dgamma(0.001, 0.001)
temperature ~ dnorm(0, 10^-6)
eleveffect ~ dgamma(0.001, 0.001) # ? can it be negative?
slopeffect ~ dnorm(0, 10^-6) # ? dnorm ?
aspecteffect ~ dgamma(0.001, 0.001) # ? can it be negative?
propbuff_unclass ~ dbeta(1, 1)
propbuff_woodland ~ dbeta(1, 1)
propbuff_wetland ~ dbeta(1, 1) 
propbuff_urban ~ dbeta(1, 1)
propbuff_freshwater ~ dbeta(1, 1)
propbuff_grassland ~ dbeta(1, 1)
propbuff_arable ~ dbeta(1, 1)
propbuff_montane ~ dbeta(1, 1)
propbuff_inlandrock ~ dbeta(1, 1)
propbuff_heather ~ dbeta(1, 1)
propbuff_coastal ~ dbeta(1, 1)
propbuff_sea ~ dbeta(1, 1)
dist_unclass ~ dgamma(0.001, 0.001)
dist_woodland ~ dgamma(0.001, 0.001)
dist_wetland ~ dgamma(0.001, 0.001)
dist_urban ~ dgamma(0.001, 0.001) 
dist_freshwater ~ dgamma(0.001, 0.001)
dist_grassland ~ dgamma(0.001, 0.001)
dist_arable ~ dgamma(0.001, 0.001)
dist_montane ~ dgamma(0.001, 0.001)
dist_inlandrock ~ dgamma(0.001, 0.001)
dist_heather ~ dgamma(0.001, 0.001)
dist_coastal ~ dgamma(0.001, 0.001) 
dist_sea ~ dgamma(0.001, 0.001)
tau ~ dgamma(0.001, 0.001) # only one tau or a tau for each prior with normal distribution
rainfquadratic ~ dnorm(0, 10^-6)
tempquadratic ~ dnorm(0, 10^-6)
elevquadratic ~ dnorm(0, 10^-6)
elevtemp_interaction ~ dgamma(0.001, 0.001) # gamma or normal distribution?
elevrainf_interaction ~ dgamma(0.001, 0.001) # gamma or normal distribution?


#data# elevation, slope, aspect, temperature, rainfall, unclassified, woodland, wetland, heather, urban, freshwater, grassland, arable_horticulture, montane_habitats, inland_rock, coastal_habitats, sea, dist_reserves, dist_parks, dist_ramsars, dist_roads, dist_water, dist_unclassified, dist_woodland, dist_wetland, dist_heather, dist_urban, dist_freshwater, dist_grassland, dist_arable_horticulture, dist_montane_habitats, dist_inland_rock, dist_coastal_habitats, dist_sea

#inits# intercept, distancewater, distanceroads, distanceparks, distancereserves, rainfeffect, tempeffect, eleveffect, slopeffect, aspecteffect, propbuff_unclass, propbuff_woodland, propbuff_wetland, propbuff_urban, propbuff_freshwater, propbuff_grassland, propbuff_arable, propbuff_montane, propbuff_inlandrock, propbuff_heather, propbuff_coastal, propbuff_sea, dist_unclass, dist_woodland, dist_wetland, dist_urban, dist_freshwater, dist_grassland, dist_arable, dist_montane, dist_inlandrock, dist_heather, dist_coastal, dist_sea, tau, rainfquadratic, tempquadratic, elevquadratic, elevtemp_interaction, elevrainf_interaction

#monitor# intercept, DIC, distancewater, distanceroads, distanceparks, distancereserves, raineffect, tempeffect, eleveffect, slopeffect, aspecteffect, propbuff_unclass, propbuff_woodland, propbuff_wetland, propbuff_urban, propbuff_freshwater, propbuff_grassland, propbuff_arable, propbuff_montane, propbuff_inlandrock, propbuff_heather, propbuff_coastal, propbuff_sea, dist_unclass, dist_woodland, dist_wetland, dist_urban, dist_freshwater, dist_grassland, dist_arable, dist_montane, dist_inlandrock, dist_heather, dist_coastal, dist_sea, tau, rainfquadratic, tempquadratic, elevquadratic, elevtemp_interaction, elevrainf_interaction
}'


library(runjags)

# Setting initial values
intercept <- list(-1, 0.7) #?
distancewater <- list(0.5, 1)
distanceroads <- list(1, 1.5)
distanceparks <- list(0.7, 1.2)
distancereserves <- list(2.5, 0.7)
rainfeffect <- list(0.3, 1)
tempeffect <- list(-2, 2)
eleveffect <- 
slopeffect <- list(-1.5, 1.5)
aspecteffect <- 
propbuff_unclass <- list(0.1, 0.4)
propbuff_woodland <- list(0.2, 0.6)
propbuff_wetland <- list(0.3, 0.7)
propbuff_urban <- list(0.4, 0.8)
propbuff_freshwater <- list(0.5, 0.9)
propbuff_grassland <- list(0.6, 1)
propbuff_arable <- list(0.7, 0.1)
propbuff_montane <- list(0.2, 0.8)
propbuff_inlandrock <- list(0.7, 0.4)
propbuff_heather <- list(0.6, 0.2)
propbuff_coastal <- list(0.1, 0.5)
propbuff_sea <- list(0, 1)
dist_unclass <- list(0.4, 1)
dist_woodland <- list(3, 5)
dist_wetland <- list(4.2, 7)
dist_urban <- list(2, 4.5)
dist_freshwater <- list(1.5, 5)
dist_grassland <- list(2.5, 1)
dist_arable <- list(0.2, 2)
dist_montane <- list(0.5, 3)
dist_inlandrock <- list(1, 3.5)
dist_heather <- list(0.3, 1)
dist_coastal <- list(1, 2)
dist_sea <- list(2, 4)
tau <- list(0.01, 1)
rainfquadratic <- list(-0.2, 1)
tempquadratic <- list(-1, 0.2)
elevquadratic <- list(-0.5, 1.2)
elevtemp_interaction <- list(-2, 2) 
elevrainf_interaction <- list()


# Running the model
results0 <- run.jags(model0, n.chains = 2, burnin = 5000, sample = 10000)
plot(results0)
results0